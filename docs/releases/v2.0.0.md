---
version: 2.0.0
date: 2025-12-05
status: released
---

# GitBook Worker v2.0.0 Release Notes

**Release Date**: December 5, 2025  
**Breaking Changes**: Yes (Docker font management architecture, emoji font configuration)  
**Migration Required**: Review `fonts.yml` configuration and Docker build setup

## ğŸ¯ Executive Summary

Version 2.0.0 marks a major milestone in the GitBook Worker evolution, transforming it from a single-language tool into a **multilingual publishing platform** with proper package structure and Docker-based builds. This release resolves a critical emoji rendering regression, introduces a new Docker font management architecture based on volume mounts, and implements the complete package migration from legacy `tools/` structure.

**Key Achievements**:
- âœ… **Multilingual Architecture**: Content managed via `content.yaml`, supporting local and remote language trees
- âœ… **Package Migration**: Full transition from legacy structure to proper `gitbook_worker` package
- âœ… **Color Emoji Fix**: Reliable rendering using Twemoji Mozilla v0.7.0 (COLR/CPAL format)
- âœ… **Smart Font Stack**: Deterministic font management with license compliance enforcement
- âœ… **Docker Volume Mounts**: Flexible font injection without image rebuilds
- âœ… **ERDA CC-BY CJK Font**: Custom-built multilingual font with Ethiopian, Indic, CJK support

## ğŸ› Critical Bug Fixes

### Emoji Color Rendering Regression (PRIMARY FIX)

**Problem**: PDFs generated after November 2025 showed black-and-white emojis despite `emoji_color: true` configuration.

**Root Cause**: Twitter Color Emoji v15.1.0 uses SVG-in-OpenType format, which LuaTeX does not support. Only COLR/CPAL color font formats (like Twemoji Mozilla) render as color in LuaTeX-based PDF pipelines.

**Solution**:
- Reverted to **Twemoji Mozilla v0.7.0** (COLR/CPAL format) across entire codebase
- Updated 40+ files to remove Twitter Color Emoji references
- Fixed `gitbook_worker/defaults/fonts.yml` EMOJI entry with correct download URL and version
- Validated color rendering in both local and Docker environments

**Impact**: All emoji characters now render in full color in PDF output (ğŸ¨ ğŸŒˆ âœ¨).

**Files Changed**:
- `gitbook_worker/defaults/fonts.yml` (EMOJI section)
- `gitbook_worker/tools/publishing/publisher.py` (docstring examples)
- `fonts-storage/twemoji-colr/TwemojiMozilla.ttf` (font binary)
- 40+ references across Lua filters, documentation, comments

## ğŸš€ New Features & Enhancements

### Multilingual Content Architecture

**Major Structural Change**: Complete repository reorganization to support multiple language editions.

**New Structure**:
```
gitbook-worker/
â”œâ”€â”€ content.yaml              # Single source of truth for all language editions
â”œâ”€â”€ de/                       # German edition (production-ready)
â”‚   â”œâ”€â”€ content/
â”‚   â”œâ”€â”€ book.json
â”‚   â”œâ”€â”€ publish.yml
â”‚   â””â”€â”€ publish/
â”œâ”€â”€ en/                       # English edition (staging)
â”œâ”€â”€ gitbook_worker/           # Python package (was: tools/)
â”‚   â”œâ”€â”€ defaults/             # fonts.yml, frontmatter.yml, smart.yml
â”‚   â”œâ”€â”€ tools/                # publishing, docker, converter, orchestrator
â”‚   â”œâ”€â”€ docs/                 # engineering docs, sprints, architecture
â”‚   â””â”€â”€ tests/
â””â”€â”€ docs/                     # user-facing documentation
```

**Benefits**:
- ğŸŒ Multiple language editions managed in single repository
- ğŸ“‹ `content.yaml` defines local and remote content sources
- ğŸ” Credential-aware handling for private remote repositories
- ğŸ”„ Shared tooling, fonts, and templates across all languages
- ğŸš€ Per-language CI/CD builds with selective execution

**New CLI**:
```bash
# Build specific language
gitbook-worker run --lang de --profile default

# Validate manifest without building
gitbook-worker validate --lang de

# List available languages
gitbook-worker list-languages
```

**Remote Content Support**:
- Git-based remote content via `type: git` in `content.yaml`
- SSH key authentication via `credentialRef` environment variables
- Automatic cloning to `.gitbook-content/<lang-id>/`
- CI cache support via `GITBOOK_CONTENT_ROOT` override

**Documentation**:
- `docs/multilingual-content-guide.md` (complete workflow)
- `docs/contributor-new-language.md` (step-by-step guide)
- `docs/HANDBOOK.md` (updated with new structure)

### Package Migration & Reorganization

**Legacy Structure Eliminated**: Complete migration from `tools/` to proper Python package.

**Changes**:
- âœ… `tools/` â†’ `gitbook_worker/` (proper package name)
- âœ… Backward-compatible import shim maintained at `tools/__init__.py`
- âœ… All documentation moved to appropriate locations:
  - User docs: `docs/` (README, guides, releases)
  - Engineering docs: `gitbook_worker/docs/` (sprints, architecture, migrations)
- âœ… Archive created: `gitbook_worker/docs/archive/legacy-package/`
- âœ… Console script: `gitbook-worker` command available after `pip install -e .`

**Module Structure**:
```python
gitbook_worker/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ defaults/          # Configuration templates
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ converter/     # Markdown preprocessing
â”‚   â”œâ”€â”€ docker/        # Container management
â”‚   â”œâ”€â”€ publishing/    # PDF generation (Pandoc/LuaTeX)
â”‚   â”œâ”€â”€ emoji/         # Emoji processing
â”‚   â”œâ”€â”€ quality/       # Link auditing, validation
â”‚   â””â”€â”€ workflow_orchestrator/  # Build pipeline
â””â”€â”€ tests/             # pytest suite (364 tests)
```

### ERDA CC-BY CJK Font System

**Custom Multilingual Font**: Built specifically for international content coverage.

**Features**:
- ğŸ“ **Glyphs**: ~7,000 characters covering Chinese, Japanese, Korean
- ğŸŒ **Scripts**: Latin, Cyrillic, Greek, Devanagari (Hindi), Ethiopic (Amharic)
- âš–ï¸ **License**: CC BY 4.0 (attribution required, commercial use allowed)
- ğŸ“¦ **Format**: TrueType (.ttf), optimized for LuaTeX
- ğŸ”§ **Builder**: Automated font generation pipeline with `.nam`, `.sfd` source files

**Coverage**:
- Ethiopian: ~450 characters (Amharic script)
- Devanagari: ~120 characters (Hindi/Sanskrit)
- CJK: Unified Ideographs + Kana + Hangul
- Latin Extended: Full European language support

**Location**: `.github/fonts/erda-ccby-cjk/` with comprehensive documentation

**Generator**: Python-based font builder with FontForge integration
- Source: `.nam` files (Unicode ranges + metadata)
- Build: `scripts/build_font.py` â†’ `true-type/erda-ccby-cjk.ttf`
- Tests: `tests/test_font_generation.py`

### Smart Font Stack & License Compliance

**Philosophy**: No hardcoded font fallbacks, explicit license tracking for all fonts.

**Core Principles** (from `smart-font-stack.md`):
1. **Single Source of Truth**: `gitbook_worker/defaults/fonts.yml`
2. **Deterministic Reproduzierbarkeit**: Same fonts.yml = identical output
3. **Platform Abstraction**: Works on Windows/macOS/Linux/Docker identically
4. **Local Cache Strategy**: `~/.cache/gitbook-worker/fonts` (Linux/macOS), `%LOCALAPPDATA%\gitbook-worker\fonts` (Windows)
5. **No Hardcoded Fallbacks**: Builds FAIL if configured fonts unavailable (prevents license violations)

**Font Configuration Format**:
```yaml
EMOJI:
  name: "Twemoji Mozilla"
  paths:
    - "fonts-storage/twemoji-colr/TwemojiMozilla.ttf"
  download_url: "https://github.com/mozilla/twemoji-colr/.../TwemojiMozilla.ttf"
  version: "0.7.0"
  license: "CC BY 4.0"
  license_url: "https://creativecommons.org/licenses/by/4.0/"
  fontconfig_name: "Twemoji Mozilla"
```

**Font Storage Bootstrap**:
- `FontStorageBootstrapper`: Downloads fonts on-demand from `fonts.yml`
- `fonts-storage/`: Local directory (gitignored), auto-populated
- Supports `.zip` archives and direct `.ttf`/`.otf` downloads
- Smart caching: Skips re-downloads if files exist

**Compliance Tools** (planned in backlog):
- `FontAttributionGenerator`: Auto-generates `ATTRIBUTION.md` from `fonts.yml`
- License validation pre-commit hooks
- Font usage auditing in published PDFs

### Docker Volume-Mount Font Architecture

**Motivation**: `fonts-storage/` directory doesn't exist in CI environments and needed dynamic population. Static `COPY` commands in Dockerfile were fragile and required rebuilds for font changes.

**New Architecture**:
```
Host Directories              Container Mounts                Container System
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.github/fonts/          â†’     /workspace/.github/fonts    â†’   /usr/share/fonts/truetype/erda-cjk/
fonts-storage/          â†’     /workspace/fonts-storage    â†’   /usr/share/fonts/truetype/
```

**Implementation**:
1. **Volume Mounts** (`run_docker.py`):
   - Mounts `.github/fonts` and `fonts-storage` as read-only volumes
   - Windows path conversion: `C:\path` â†’ `/c/path` for Docker Desktop compatibility
   - OSFONTDIR environment variable: `/workspace/.github/fonts:/workspace/fonts-storage`

2. **Runtime Font Installation** (`Dockerfile.dynamic` entrypoint):
   ```bash
   # Entrypoint script copies fonts from volumes to system directories
   cp -r /workspace/.github/fonts/* /usr/share/fonts/truetype/erda-cjk/
   find /workspace/fonts-storage -name "*.ttf" -o -name "*.otf" \
       | xargs cp -t /usr/share/fonts/truetype/
   fc-cache -fv /usr/share/fonts/truetype
   ```

3. **Build-Time Optimization** (`setup_docker_environment.py`):
   - Added `--skip-local-fonts` flag to skip fonts with local paths during image build
   - Fonts are installed at container startup when volumes are available

**Benefits**:
- âœ… No Dockerfile rebuild needed for font changes
- âœ… Works when `fonts-storage/` doesn't exist (auto-created by `run_docker.py`)
- âœ… Fonts available to both `fontconfig` (fc-list) and LuaTeX
- âœ… Cleaner separation: image build vs. runtime font injection

**Verification**:
```bash
# Inside container after startup
fc-list | grep -i twemoji  # Shows: Twemoji Mozilla
fc-list | grep -i erda     # Shows: ERDA CC-BY CJK
pdffonts output.pdf        # Shows: TwemojiMozilla embedded
```

### Explicit Font Configuration Enforcement

**New Policy** (per AGENTS.md sections 12-14):
- ALL fonts MUST be defined in `gitbook_worker/defaults/fonts.yml`
- NO hardcoded font fallbacks or automatic system font discovery
- Builds fail explicitly if configured fonts are unavailable

**Benefits**:
- ğŸ“‹ **License Compliance**: Every font's license tracked and documented
- ğŸ”„ **Attribution Requirements**: Can generate proper attribution for all fonts
- ğŸ—ï¸ **Reproducible Builds**: Identical font configuration across all environments
- âš ï¸ **Fail Fast**: No silent fallbacks to system fonts with unknown licenses

**Example `fonts.yml` entry**:
```yaml
EMOJI:
  name: "Twemoji Mozilla"
  paths:
    - "fonts-storage/twemoji-colr/TwemojiMozilla.ttf"
  download_url: "https://github.com/mozilla/twemoji-colr/releases/download/v0.7.0/TwemojiMozilla.ttf"
  version: "0.7.0"
  license: "CC BY 4.0"
  license_url: "https://creativecommons.org/licenses/by/4.0/"
  fontconfig_name: "Twemoji Mozilla"
```

## ğŸ”§ Technical Changes

### Modified Components

**`gitbook_worker/tools/docker/run_docker.py`**:
- Added `_windows_path_to_docker()` helper for path conversion
- Modified `build_docker_args()` to mount volumes and set OSFONTDIR
- Auto-creates `fonts-storage/` directory if missing
- Changed font checks from `fc-list | grep` to file existence + fc-cache

**`gitbook_worker/tools/docker/Dockerfile.dynamic`**:
- Removed static `COPY` commands for font directories
- Added runtime font installation logic to entrypoint script
- Entrypoint now copies fonts from volumes to `/usr/share/fonts/truetype/`
- Runs `fc-cache -fv` after font installation

**`gitbook_worker/tools/docker/setup_docker_environment.py`**:
- Added `--skip-local-fonts` flag (line ~767)
- Modified `install_all_fonts()` to skip fonts with local paths during build
- Logs: "Skipping {font}: Has local paths (will be mounted at runtime)"

**`gitbook_worker/defaults/fonts.yml`**:
- Fixed EMOJI entry with correct Twemoji Mozilla configuration
- Updated `download_url` from Twitter Color Emoji to Twemoji Mozilla
- Corrected version from 15.1.0 to 0.7.0
- Fixed empty `paths:` to `fonts-storage/twemoji-colr/TwemojiMozilla.ttf`

### Documentation Updates

**`docs/HANDBOOK.md`**:
- Clarified Docker vs. local execution paths
- Added explicit Docker execution examples with `run_docker.py`
- Documented key difference: `run_docker.py` builds image and starts container; `--profile docker` is just a profile name

**`README.md`**:
- Updated version to 2.0.0
- Enhanced Font Management & License Compliance section
- Added references to `fonts.yml` as single source of truth

**`AGENTS.md`**:
- Sections 12-14 already documented font management requirements
- No changes needed (requirements already enforced in v2.0.0)

## âš ï¸ Breaking Changes

### 1. Repository Structure & Package Location
**Old Behavior**: Tools located at `tools/` in repository root.

**New Behavior**: Python package at `gitbook_worker/` with proper module structure.

**Migration**:
```python
# Old imports (still work via compatibility shim)
from tools.publishing.publisher import Publisher

# New imports (preferred)
from gitbook_worker.tools.publishing.publisher import Publisher
```

**Impact**:
- CI/CD workflows may need path updates
- Direct `python tools/...` calls should use `python -m gitbook_worker.tools....`
- Or use new CLI: `gitbook-worker run --lang de`

### 2. Content Structure & Language Selection
**Old Behavior**: Single content tree, manual path specification.

**New Behavior**: Multi-language content via `content.yaml`, `--lang` flag required.

**Migration**:
```bash
# Old command
python -m tools.workflow_orchestrator run --root . --manifest publish.yml

# New command
gitbook-worker run --lang de --profile default
```

**Impact**:
- All builds must specify `--lang <id>` parameter
- Content must be organized in `<lang>/` directories
- `content.yaml` must list all available languages

### 3. Docker Font Management
**Old Behavior**: Fonts were copied into Docker image at build time via static `COPY` commands.

**New Behavior**: Fonts are mounted as volumes and installed at container startup.

**Migration**:
- If using custom Docker builds, update to new `Dockerfile.dynamic` from this release
- Ensure `.github/fonts/` and `fonts-storage/` directories exist on host
- Use `run_docker.py` module for Docker execution (handles volume mounts automatically)

**Docker Execution Change**:
```bash
# Old (direct Dockerfile COPY)
docker build -t gitbook-worker .
docker run -v $(pwd):/workspace gitbook-worker

# New (volume-mount fonts)
python -m gitbook_worker.tools.docker.run_docker orchestrator --use-dynamic
```

### 4. Emoji Font Configuration
**Old Behavior**: Twitter Color Emoji v15.1.0 (SVG-in-OpenType format).

**New Behavior**: Twemoji Mozilla v0.7.0 (COLR/CPAL format).

**Migration**:
- No action required if using default `fonts.yml`
- If custom font configuration exists, update EMOJI entry to Twemoji Mozilla
- Remove any Twitter Color Emoji v15.x references

**Visual Impact**: PDFs now show **color emojis** (not black-and-white)

### 5. Explicit Font Requirements
**Old Behavior**: System fonts could be used as fallbacks.

**New Behavior**: All fonts MUST be in `fonts.yml`; builds fail if fonts unavailable.

**Migration**:
- Review any custom font usage
- Add entries to `fonts.yml` for all fonts used in documents
- Test builds to ensure no missing font errors
- Use `FontStorageBootstrapper` to auto-download missing fonts

### 6. Documentation Location
**Old Behavior**: Mixed documentation in various locations.

**New Behavior**: Clear separation between user and engineering docs.

**Migration**:
```
Old Location              â†’  New Location
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
docs/sprints/            â†’  gitbook_worker/docs/sprints/
docs/architecture/       â†’  gitbook_worker/docs/architecture/
README.md (root)         â†’  README.md (unchanged)
docs/guides/             â†’  docs/ (user-facing)
```

**Impact**:
- Update documentation links in code
- CI workflows may reference new paths
- Legacy docs archived in `gitbook_worker/docs/archive/`

## ğŸ“Š Performance Improvements

- **Docker Build Time**: Volume mounts eliminate font-related layer rebuilds
- **Container Startup**: ~2-3 seconds for font installation (one-time per container start)
- **Font Cache**: fc-cache runs once at startup instead of per-build
- **Local Builds**: No changes to local build performance (still ~5 seconds with cached fonts)

## ğŸ§ª Testing & Quality Assurance

**Test Coverage**:
- âœ… All 364 tests pass (pytest suite)
- âœ… Docker orchestrator builds complete successfully
- âœ… PDF output verified with `pdffonts`: TwemojiMozilla embedded
- âœ… Visual inspection: Color emojis render correctly in output PDFs
- âœ… Windows/Linux path compatibility validated

**Test Artifacts**:
- Generated PDFs with color emojis (verified via `pdffonts` output)
- Docker container logs showing runtime font installation
- fc-list output confirming Twemoji Mozilla and ERDA CC-BY CJK availability

## ğŸ“¦ Upgrade Instructions

### For Local Development

1. **Pull latest changes**:
   ```bash
   git checkout main
   git pull origin main
   ```

2. **Update dependencies** (if changed):
   ```bash
   pip install -e . --upgrade
   ```

3. **Verify local build**:
   ```bash
   gitbook-worker run --lang de --profile local
   pdffonts de/publish/das-erda-buch.pdf | grep Twemoji
   # Should show: TwemojiMozilla
   ```

### For Docker-Based Builds

1. **Rebuild Docker image** (required for entrypoint changes):
   ```bash
   python -m gitbook_worker.tools.docker.run_docker orchestrator \
       --profile default --use-dynamic --rebuild --no-cache
   ```

2. **Verify fonts in container**:
   ```bash
   docker run --rm erda-smart-worker bash -c "fc-list | grep -i twemoji"
   # Should show: Twemoji Mozilla
   ```

3. **Run orchestrator**:
   ```bash
   python -m gitbook_worker.tools.docker.run_docker orchestrator \
       --profile default --use-dynamic
   ```

### For CI/CD Pipelines

1. **Update Dockerfile reference** to `Dockerfile.dynamic` (if using static)
2. **Ensure volume mounts** are configured (handled automatically by `run_docker.py`)
3. **No changes needed** if already using `run_docker.py` module

## ğŸ”— Related Resources

- **Font License Compliance**: `AGENTS.md` sections 12-14
- **Docker Architecture**: `docs/HANDBOOK.md` Docker usage paths
- **Contributor Guide**: `docs/contributor-new-language.md`
- **Font Configuration**: `gitbook_worker/defaults/fonts.yml`
- **Twemoji Mozilla**: https://github.com/mozilla/twemoji-colr

## ğŸ™ Acknowledgments

- **Mozilla Twemoji Project**: For maintaining COLR/CPAL emoji font format
- **LuaTeX Community**: For documentation on color font support limitations
- **Docker Community**: For volume mount best practices

## ğŸ“ Commit History Highlights (Last 4 Weeks)

**Package Migration & Structure** (November 25-27, 2025):
- `77482ef`: Relocate gitbook_worker package and refresh docs
- `9c560f0`: Add CI guardrails and root handbook
- `f6e58ef`: Prepare Sprint for v.2.0.0
- `6613443`: Reordered repo structure

**Font Management Revolution** (November 28-29, 2025):
- `28a21cf`: Add smart font stack and font sync CLI
- `7e7b89c`: Add ERDA font builders and generated TTFs
- `50bda7d`: Improve font sync orchestration
- `8f4b00d`: Add managed font storage bootstrap
- `31dfeb7`: Add ERDA sprintable backlog and fix font loader metadata
- `37afe53`: Fix Docker font install and adjust README exclusions

**Publishing Stability** (December 1-2, 2025):
- `2a11246`: Implement sprint validation and publishing stability
- `d5e7a7a`: Align publishing stack with prod
- `e1daf04`: Fix pytest warnings and CLI tests
- `cd4bd47`: Add Twitter Color Emoji via FontStorageBootstrapper with smart cache checking

**Emoji Color Fix** (December 3-4, 2025):
- `be67fa9`: Update tests for Twitter Color Emoji (was Twemoji)
- `c52b1ba`: Add font attribution generator backlog document
- `25d1191`: **Revert to Twemoji Mozilla (COLR/CPAL) for color emoji rendering** â­
- `bc0cd68`: Update docstring examples from Twitter Color Emoji to Twemoji Mozilla

**Key Milestones**:
- 40+ files updated in emoji color fix
- 364 tests maintained and passing
- Complete font management documentation added
- Docker architecture redesigned
- Multi-language structure implemented

## ğŸ“‹ Known Issues & Limitations

1. **Windows Path Conversion**: Requires Docker Desktop on Windows (not Hyper-V isolation)
2. **Font Cache Timing**: First container start takes 2-3 seconds longer for font installation
3. **Volume Mount Performance**: Slight I/O overhead on macOS/Windows (negligible in practice)
4. **Remote Content**: Git cloning requires SSH key configuration (not HTTPS yet)
5. **English Edition**: Staging status, not production-ready (use `de/` as reference)

## ğŸ”® Future Roadmap (Backlog)

### Font & License Management
- [ ] **Font Attribution Generator** (`gitbook_worker/docs/backlog/font-attribution-generator.md`)
  - Auto-generate `ATTRIBUTION.md` from `fonts.yml`
  - Create `LICENSE-FONTS` file with all font licenses
  - Orchestrator integration via `manifest.generate_attribution` flag
  - Estimate: 6-8 hours

- [ ] **Font Storage Dynamic Generation** (`gitbook_worker/docs/backlog/font-storage-dynamic-generation.md`)
  - Parse `fonts.yml` â†’ generate `FontBundleSpec` objects
  - Auto-download fonts from configured URLs
  - Version tracking and integrity checks
  - Estimate: 8-10 hours

- [ ] **License Policy Management** (`gitbook_worker/docs/backlog/license-policy-management.md`)
  - Validate font licenses before builds
  - Pre-commit hooks for font configuration changes
  - Automated license compatibility checks

### Testing & Quality
- [ ] **Publish.yml Comprehensive Testing** (`gitbook_worker/docs/backlog/publish-yml-comprehensive-testing.md`)
  - Multi-language test matrix
  - Font configuration validation tests
  - Remote content source tests
  - Estimate: 10-12 hours

### Features
- [ ] Add automated font subsetting for smaller PDF sizes
- [ ] Explore alternative color font formats (COLRv1, sbix)
- [ ] HTTPS support for remote Git repositories
- [ ] Parallel language builds in CI
- [ ] Interactive language selection TUI
- [ ] Font preview generator for documentation

### Infrastructure
- [ ] PyPI package publication
- [ ] Docker Hub image publication
- [ ] GitHub Releases automation
- [ ] Automated changelog generation

---

**Full Changelog**: https://github.com/Rob9999/gitbook-worker/compare/v1.1.0...v2.0.0
