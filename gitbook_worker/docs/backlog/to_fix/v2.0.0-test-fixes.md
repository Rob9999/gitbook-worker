---
version: 1.0.0
date: 2025-01-XX
history:
  - v1.0.0: Initial test fix documentation for v2.0.0 release
---

# v2.0.0 Test Suite Fixes

## Executive Summary
- **Test Results**: 371 passed (95.1%), 14 failed (3.6%), 5 skipped (1.3%)
- **Test Duration**: 276.56 seconds (4:36)
- **PROD Code Impact**: **NONE** - all failures are test infrastructure issues
- **PO Approval Required**: **NO** - only test code changes

## Failure Categories

### Category 1: Font API Signature Mismatches (8 tests)
**Root Cause**: Recent API changes added required parameters to `_build_font_header()`:
- `temp_dir` (keyword-only, required)
- `abort_if_missing_glyph` (keyword-only, required)

Tests were not updated to match new signature.

**Affected Tests**:
1. `test_font_fallback_guard.py::test_raises_when_lua_cache_missing`
2. `test_font_fallback_guard.py::test_uses_fallback_when_lua_cache_available`
3. `test_publisher.py::test_font_header_includes_manual_fallback_block`
4. `test_publisher.py::test_run_pandoc_tex_to_pdf`
5. `test_publisher.py::test_run_pandoc_md_to_pdf`
6. `test_publisher.py::test_run_pandoc_md_to_pdf_with_emoji`
7. `test_publisher.py::test_run_pandoc_md_to_pdf_with_toc`
8. `test_publisher.py::test_run_pandoc_md_to_pdf_full_doc`

**Error Message**:
```
TypeError: _build_font_header() missing 1 required keyword-only argument: 'temp_dir'
```

### Category 2: Docker Environment Unavailable (5 tests)
**Root Cause**: Docker Desktop not running on Windows test environment.

**Affected Tests**:
1. `test_full_orchestrator_pipeline.py::test_orchestrator_readme_no_deletions`
2. `test_orchestrator_readme_docker.py::test_orchestrator_readme_static_no_deletions`
3. `test_orchestrator_readme_docker.py::test_orchestrator_readme_dynamic_no_deletions`
4. `test_orchestrator_readme_docker.py::test_orchestrator_readme_profile_detection_static`
5. `test_orchestrator_readme_docker.py::test_orchestrator_readme_profile_detection_dynamic`

**Error Message**:
```
subprocess.CalledProcessError: Command '['docker', 'build', ...]' returned non-zero exit status 1
ERROR: error during connect: open //./pipe/dockerDesktopLinuxEngine: The system cannot find the file
```

**Classification**: Environment dependency, not code issue. These tests should be skipped when Docker unavailable.

### Category 3: LuaTeX Font Cache Missing (6 tests)
**Root Cause**: Font cache not initialized in test environment. Tests call `_run_pandoc` which requires fonts registered with luaotfload.

**Affected Tests**:
1. `test_publisher.py::test_run_pandoc_tex_to_pdf`
2. `test_publisher.py::test_run_pandoc_md_to_pdf`
3. `test_publisher.py::test_run_pandoc_md_to_pdf_with_emoji`
4. `test_publisher.py::test_run_pandoc_md_to_pdf_with_toc`
5. `test_publisher.py::test_run_pandoc_md_to_pdf_full_doc`
6. `test_publisher.py::test_run_pandoc_md_to_pdf_with_images`

**Error Message**:
```
RuntimeError: LuaTeX cache fehlt: DejaVu Sans; Twemoji Mozilla
Keine der konfigurierten Fallback-Fonts ist verfügbar
```

**Note**: Same 5 tests overlap with Category 1 (signature issue prevents reaching font cache check).

## Proposed Fixes (Test Code Only)

### Fix 1: Update Font Fallback Guard Tests
**File**: `gitbook_worker/tests/test_font_fallback_guard.py`

**Lines 7-15**: Update `_BASE_ARGS` dictionary:
```python
_BASE_ARGS = dict(
    main_font="Serif",
    sans_font="Sans",
    mono_font="Mono",
    emoji_font=None,
    include_mainfont=True,
    needs_harfbuzz=False,
    manual_fallback_spec="FooFallback;BarFallback",
    abort_if_missing_glyph=False,
    temp_dir="/tmp/test-font-cache",  # ADD THIS LINE
)
```

**Impact**: Fixes 2 tests in `test_font_fallback_guard.py`

### Fix 2: Update Publisher Test Signature
**File**: `gitbook_worker/tests/test_publisher.py`

**Lines 76-83**: Add missing parameters:
```python
def test_font_header_includes_manual_fallback_block():
    header = publisher._build_font_header(
        main_font="Main",
        sans_font="Sans",
        mono_font="Mono",
        emoji_font="Emoji",
        include_mainfont=True,
        needs_harfbuzz=True,
        manual_fallback_spec="Fallback:mode=harf",
        abort_if_missing_glyph=False,  # ADD THIS LINE
        temp_dir="/tmp/test-font-cache",  # ADD THIS LINE
    )
```

**Impact**: Fixes 1 test signature error, allows remaining 6 tests to reach font cache check

### Fix 3: Initialize Font Cache in Test Setup
**File**: `gitbook_worker/tests/conftest.py`

**Add session-scoped fixture**:
```python
import subprocess
import pytest

@pytest.fixture(scope="session", autouse=True)
def initialize_luaotfload_cache():
    """
    Ensure luaotfload font database is initialized before any tests run.
    
    This fixture runs once per test session and updates the LuaTeX font cache.
    If luaotfload-tool is not available, tests requiring it will be skipped.
    """
    try:
        result = subprocess.run(
            ["luaotfload-tool", "--update", "--force"],
            check=False,
            capture_output=True,
            text=True,
            timeout=60
        )
        if result.returncode != 0:
            pytest.skip(f"Font cache initialization failed: {result.stderr}")
    except FileNotFoundError:
        pytest.skip("luaotfload-tool not available in test environment")
    except subprocess.TimeoutExpired:
        pytest.skip("Font cache initialization timed out")
```

**Impact**: Fixes 6 font cache errors in `test_publisher.py`

**Alternative**: If cache initialization is too slow, mock `_check_luaotfload_has_font` to return `True` in affected tests.

### Fix 4: Mark Docker Tests as Conditional
**File**: `gitbook_worker/tests/test_full_orchestrator_pipeline.py`

**Add helper function at module level**:
```python
import shutil

def docker_available() -> bool:
    """Check if Docker is available and running."""
    if not shutil.which("docker"):
        return False
    try:
        result = subprocess.run(
            ["docker", "info"],
            check=False,
            capture_output=True,
            timeout=5
        )
        return result.returncode == 0
    except (subprocess.TimeoutExpired, FileNotFoundError):
        return False
```

**Apply to tests**:
```python
@pytest.mark.skipif(not docker_available(), reason="Docker Desktop not running")
def test_orchestrator_readme_no_deletions():
    ...
```

**Files to update**:
- `gitbook_worker/tests/test_full_orchestrator_pipeline.py` (1 test)
- `gitbook_worker/tests/test_orchestrator_readme_docker.py` (4 tests)

**Impact**: 5 Docker tests will skip gracefully with clear reason

## Implementation Priority

1. **High Priority** (blocks test suite green): Fix 1, 2, 3
2. **Medium Priority** (improves CI/CD): Fix 4

## Verification Steps

After implementing fixes:
```powershell
.\.venv\Scripts\python.exe -m pytest -v --tb=short
```

**Expected Result**:
- 379 passed (371 + 8 fixed)
- 0 failed
- 10 skipped (5 existing + 5 Docker)
- Duration: ~4:30 (similar to current)

## PROD Code Impact Assessment

**Analysis**: None of the test failures indicate PROD code issues.

**Evidence**:
- ✅ Local orchestrator runs successful (DE, EN)
- ✅ PDF builds working
- ✅ Content directory pollution fixed (commit f33aefd)
- ✅ 371 tests passing (95.1%)

**Test failures are exclusively**:
- API signature mismatches from recent refactoring
- Environment dependencies (Docker, font cache)

**Conclusion**: No PO approval required for these fixes.

## Notes
- All proposed changes are in test files only
- No changes to production code in `gitbook_worker/tools/`
- Changes maintain test coverage and improve robustness
- Docker tests can be validated later when Docker Desktop is running
